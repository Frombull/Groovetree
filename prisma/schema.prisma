generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                      String           @id @default(cuid())
  email                   String           @unique
  name                    String?
  password                String? // Optional for OAuth users
  provider                String? // "google", "spotify", or null for email/password
  providerId              String? // OAuth provider user ID
  emailVerified           Boolean          @default(false)
  emailVerificationToken  String?          @unique
  emailVerificationExpiry DateTime?
  createdAt               DateTime         @default(now())
  updatedAt               DateTime         @updatedAt
  page                    Page? // User can have only one page
  favorites               FavoriteArtist[] // Artistas favoritos do usuário

  @@unique([provider, providerId]) // Unique constraint for OAuth users
}

model Page {
  id                 String  @id @default(cuid())
  slug               String  @unique // Username in the URL /artist-name/
  title              String
  bio                String?
  avatarUrl          String?
  backgroundColor    String?
  textColor          String?
  backgroundImageUrl String?

  userId      String           @unique // One-to-one relationship
  user        User             @relation(fields: [userId], references: [id])
  links       Link[]
  events      Event[]
  embeds      Embed[]
  photos      Photo[]
  favoritedBy FavoriteArtist[] // Usuários que favoritaram este artista
  pageViews   PageView[] // Analytics: visualizações da página
  shareEvents ShareEvent[] // Analytics: compartilhamentos

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum LinkType {
  GENERIC
  SPOTIFY
  APPLE_MUSIC
  DEEZER
  YOUTUBE
  SOUNDCLOUD
  BEATPORT
  INSTAGRAM
  TIKTOK
  FACEBOOK
  TWITTER
  TOUR
}

model Link {
  id       String   @id @default(cuid())
  title    String
  url      String
  embedUrl String? // URL do embed (opcional, gerado automaticamente)
  type     LinkType @default(GENERIC)
  order    Int      @default(0)
  isActive Boolean  @default(true)

  pageId    String
  page      Page     @relation(fields: [pageId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Event {
  id        String   @id @default(cuid())
  title     String
  venue     String
  city      String
  state     String? // Estado (opcional)
  date      DateTime
  ticketUrl String?
  isActive  Boolean  @default(true)

  pageId    String
  page      Page     @relation(fields: [pageId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Embed {
  id       String  @id @default(cuid())
  title    String?
  embedUrl String
  type     String // "YOUTUBE_VIDEO", "SPOTIFY_ALBUM"
  order    Int     @default(0)
  isActive Boolean @default(true)

  pageId    String
  page      Page     @relation(fields: [pageId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Photo {
  id       String  @id @default(cuid())
  imageUrl String // URL da imagem
  caption  String? // Texto do overlay (opcional)
  order    Int     @default(0)
  isActive Boolean @default(true)

  pageId    String
  page      Page     @relation(fields: [pageId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model FavoriteArtist {
  id     String @id @default(cuid())
  userId String
  pageId String // ID da página do artista favorito

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  page Page @relation(fields: [pageId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([userId, pageId]) // Um usuário não pode favoritar o mesmo artista duas vezes
}

// Analytics Models
model PageView {
  id     String @id @default(cuid())
  pageId String

  page      Page     @relation(fields: [pageId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@index([pageId, createdAt]) // Index para queries rápidas por página e data
}

model ShareEvent {
  id       String  @id @default(cuid())
  pageId   String
  platform String? // "facebook", "twitter", "whatsapp", "copy", etc.

  page      Page     @relation(fields: [pageId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@index([pageId, createdAt]) // Index para queries rápidas por página e data
}
